<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Intelligent Artifice - EventHub</title>
        <link rel="stylesheet" href="http://www.mikelanzetta.com/theme/css/main.css" />
        <link href="http://www.mikelanzetta.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Intelligent Artifice Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
<a href="https://github.com/noodlefrenzy">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="http://www.mikelanzetta.com/">Intelligent Artifice </a></h1>
                <nav><ul>
                    <li><a href="http://www.mikelanzetta.com/pages/about-me-and-this-blog.html">About Me And This Blog</a></li>
                    <li><a href="http://www.mikelanzetta.com/category/machine-learning.html">Machine Learning</a></li>
                    <li><a href="http://www.mikelanzetta.com/category/meta.html">Meta</a></li>
                    <li><a href="http://www.mikelanzetta.com/category/software.html">Software</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://www.mikelanzetta.com/real-time-mapping-with-signalr-and-event-hubs.html">Real-time Mapping with SignalR and Event Hubs</a></h1>
<footer class="post-info">
        <abbr class="published" title="2015-08-18T10:20:00-07:00">
                Published: Tue 18 August 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://www.mikelanzetta.com/author/noodlefrenzy.html">noodlefrenzy</a>
        </address>
<p>In <a href="http://www.mikelanzetta.com/category/software.html">Software</a>.</p>
<p>tags: <a href="http://www.mikelanzetta.com/tag/net.html">.NET</a> <a href="http://www.mikelanzetta.com/tag/c.html">C#</a> <a href="http://www.mikelanzetta.com/tag/eventhub.html">EventHub</a> <a href="http://www.mikelanzetta.com/tag/geo.html">Geo</a> <a href="http://www.mikelanzetta.com/tag/websockets.html">WebSockets</a> </p>
</footer><!-- /.post-info --><p>One of my recent projects had to do with watching people moving around
the city - not in a creepy stalker way, but trying to get some sense of
where people congregated and general walking traffic flow. As anyone who
has dealt with large data, especially large geo data can tell you -
visualization is everything. Somehow looking at a screen full of
lat/long coordinates and timestamps just doesn't tell you a story like
seeing things play out on the
map.</p>
<p><a href="http://www.mikelanzetta.com/images/route_animation.gif"><img alt="route_animation" src="http://www.mikelanzetta.com/images/route_animation.gif"></a></p>
<p>So what if you have large amounts of geo data coming in from different
users, say via a high-scale queuing mechanism like Event Hubs? What if
you want to display that to anyone who wants to see it, in
near-real-time? I decided to use <a href="http://leafletjs.com/">Leaflet</a>(a
great open-source JS mapping package (<a href="http://amzn.to/1J4LHxd">book</a>))
and <a href="http://signalr.net/">SignalR</a>(a great open-source
<a href="http://amzn.to/1J4LKZW">WebSockets</a>package for ASP.Net
(<a href="http://amzn.to/1HLx29i">book</a>)) to make that happen. As always, I've
released all of my code <a href="https://github.com/noodlefrenzy/asp-mappy">on
GitHub</a>, and I'll walk you
through the steps needed to make this scenario happen.</p>
<h2>Mapping with Leaflet.js</h2>
<p>Let's start at the front - how can I show a map on the screen? There are
a ton of libraries out there - for apps, full desktop applications, and
websites. Let's assume we're going to be building a website, and want a
Javascript solution. Even there, we have many options - from our own
Bing Maps to Google Maps or even MapQuest. However, I like
<a href="http://leafletjs.com/">Leaflet.js</a> for a few reasons - first, they have
an easy to use and <a href="http://leafletjs.com/reference.html">well</a>
<a href="http://leafletjs.com/examples.html">documented</a>API; second, they can
work with a variety of different tile-sets, so you can develop on
OpenMaps and then later swap your look-and-feel for a more Bing Maps
style with a one line code change.</p>
<p>Integrating Leaflet into your code is as simple as including their CSS
and Javascript, which I've done via their CDN links:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
...
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css&quot;</span> <span class="p">/&gt;</span>
...
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
...
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
...
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</pre></div>


<p>I chose to put it into <code>_Layout.cshtml</code> since this was the crux of my
site. To use Leaflet, I picked a center-point and zoom level for my map,
added a well-named <code>div</code>, picked a size for it, and created a map:</p>
<div class="highlight"><pre><span></span>// from site.css:
#map { height: 500px; }

// from _Home.cshtml:
<span class="c">&lt;!-- ko with: home --&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Mappy<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
        ...
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-md-8&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;map&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="c">&lt;!-- /ko --&gt;</span>

// from Index.cshtml:
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    var centerLat = @ViewBag.CenterLatitude;
    var centerLon = @ViewBag.CenterLongitude;
    var zoom = 13;
    var map = L.map(&#39;map&#39;).setView([centerLat, centerLon], zoom);
    L.tileLayer(&#39;https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}&#39;, {
        attribution: &#39;Map data <span class="ni">&amp;copy;</span> <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;http://openstreetmap.org&quot;</span><span class="p">&gt;</span>OpenStreetMap<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span> contributors, <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;http://creativecommons.org/licenses/by-sa/2.0/&quot;</span><span class="p">&gt;</span>CC-BY-SA<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>, Imagery © <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;http://mapbox.com&quot;</span><span class="p">&gt;</span>Mapbox<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>[…]&#39;,
        maxZoom: 18,
        id: &#39;@ViewBag.MapsId&#39;,
        accessToken: &#39;@ViewBag.MapsAccessToken&#39;
    }).addTo(map);
...
</pre></div>


<p>Note the highlighted lines where I pull constants from the ViewBag -
this allows me to factor out my maps app ID and access token, as well as
the center-point for my map.</p>
<h2>Real-time Geo Data with SignalR</h2>
<h4>SignalR Server-Side</h4>
<p>Integrating SignalR isn't much more difficult than Leaflet.js, but it
has to integrate at two different layers of the stack since it's the
bridge between them. Including it in your ASP.Net application is done as
you would expect - Install the <code>Microsoft.AspNet.SignalR</code> NuGet package.
Once that's installed you'll need to decide how you want to use it
to send data from server to clients - I've used <a href="http://www.asp.net/signalr/overview/guide-to-the-api/hubs-api-guide-javascript-client">SignalR
Hubs</a>in
this example, as it allowed me to create different hubs for different
purposes (although I'm only using one in this example code).</p>
<p>Creating a Hub is as simple as creating a class inheriting from the
appropriate <code>Hub</code> class and implementing a few methods. Behind the
scenes it creates the appropriate proxies and lets you do your client
wiring from there. The server-side needs to get the hub context instance
and then use that to send data to clients, while the hub uses its
internal Clients.All dynamic collection to deliver that data. I use a
simple static method on my Hub to allow server-side code to find the hub
context from the global connection, making calling code trivial to
implement. As a result, the Hub code looks like:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">RouteHub</span> <span class="p">:</span> <span class="n">Hub</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">RouteHub</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">IHubContext</span> <span class="nf">Hub</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">GlobalHost</span><span class="p">.</span><span class="n">ConnectionManager</span><span class="p">.</span><span class="n">GetHubContext</span><span class="p">&lt;</span><span class="n">RouteHub</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Send</span><span class="p">(</span><span class="n">IHubContext</span> <span class="n">hub</span><span class="p">,</span> <span class="kt">string</span> <span class="n">userId</span><span class="p">,</span> <span class="kt">float</span> <span class="n">lat</span><span class="p">,</span> <span class="kt">float</span> <span class="n">lon</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">hub</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">All</span><span class="p">.</span><span class="n">newPoint</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Send</span><span class="p">(</span><span class="kt">string</span> <span class="n">userId</span><span class="p">,</span> <span class="kt">float</span> <span class="n">lat</span><span class="p">,</span> <span class="kt">float</span> <span class="n">lon</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Clients</span><span class="p">.</span><span class="n">All</span><span class="p">.</span><span class="n">newPoint</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Note the <code>Clients.All.newPoint()</code> call - newPoint is a <code>dynamic</code> method
which gets wired into the created proxy and passed through to the
client, as you'll see below. Calling the hub from the server is as easy
as:</p>
<div class="highlight"><pre><span></span><span class="n">RouteHub</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">RouteHub</span><span class="p">.</span><span class="n">Hub</span><span class="p">(),</span> <span class="n">pt</span><span class="p">.</span><span class="n">UserID</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">pt</span><span class="p">.</span><span class="n">Latitude</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">pt</span><span class="p">.</span><span class="n">Longitude</span><span class="p">)</span>
</pre></div>


<p>One thing to notice is that I'm casting the <code>doubles</code> I have internally
for lat/lon into <code>floats</code> when passing them down the wire. SignalR seems
to have trouble passing <code>doubles</code> through to Javascript - possibly
because the language doesn't support them - limiting it to <code>floats</code>
fixes the problem. Now that we have the hub created, we just need to
start SignalR itself when we start up our website - we do this in the
Startup.cs code with the addition of a single line:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">app</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">app</span><span class="p">.</span><span class="n">MapSignalR</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h4>Wiring the SignalR Client</h4>
<p>Now that we have a server which can send us data, we need to wire up the
client to receive it. Wiring SignalR in the client requires
three modifications. First - include the hubs, allowing the client code
to talk to the proxies. Second - create a handler to process
incoming messages from the hub you're listening to. Finally - start
listening. This is actually a pretty small chunk of code, as you can see
here:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;~/Scripts/jquery.signalR-2.2.0.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;~/signalr/hubs&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">routeHub</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">routeHub</span><span class="p">;</span>
        <span class="nx">routeHub</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">newPoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">userid</span><span class="p">,</span> <span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Do something exciting!</span>
        <span class="p">};</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">hub</span><span class="p">.</span><span class="nx">start</span><span class="p">().</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>


<p>Note the reappearance of the <code>newPoint</code> method - this must correspond
with the dynamic method you're calling from within the Hub above (via
<code>Clients.All</code>).</p>
<h2>Geo Data and Event Hub</h2>
<p>So now I have a client-server connection, and a map. Let's see if I
can't send some data to that map! Since I'm planning on having hundreds
or thousands of users sending me geo data, and I'm going to want to use
this geo data for more than just mapping, <a href="http://azure.microsoft.com/en-us/services/event-hubs/">Event
Hubs</a> seems like
a natural mechanism to decouple the senders from the receivers. The one
caveat with writing a receiver for Event Hubs is that they have to
manage their own state (context) so they can pick up where they left
off. I'll be using the Azure-provided <code>EventProcessorHost</code> library to do
that work for me - it stores offset data for each partition in Azure
Blob storage and uses blob leases for ad-hoc load balancing, so is quite
a useful little piece of code, and is simple to set up. You just NuGet
install Microsoft.Azure.ServiceBus.EventProcessorHost, and then
implement and instantiate your event processor. I've chosen to
use/assume JSON serialization via Newtonsoft's Json.NET, and my data
payload class looks like:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">RoutePointEH</span> <span class="p">:</span> <span class="n">IRoutePoint</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">double</span> <span class="n">Latitude</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">double</span> <span class="n">Longitude</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">UserID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">DateTime</span> <span class="n">MeasurementTime</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">DateTime</span> <span class="n">Timestamp</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>(I'll come back to the reason for the <code>IRoutePoint</code> interface), while
the resulting EventProcessor looks like:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">RoutePointProcessorFactory</span> <span class="p">:</span> <span class="n">IEventProcessorFactory</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">RoutePointProcessorFactory</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">IRoutePoint</span><span class="p">&gt;</span> <span class="n">onItem</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">onItemCB</span> <span class="p">=</span> <span class="n">onItem</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IEventProcessor</span> <span class="nf">CreateEventProcessor</span><span class="p">(</span><span class="n">PartitionContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RoutePointProcessor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">onItemCB</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">IRoutePoint</span><span class="p">&gt;</span> <span class="n">onItemCB</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">RoutePointProcessor</span> <span class="p">:</span> <span class="n">IEventProcessor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">RoutePointProcessor</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">IRoutePoint</span><span class="p">&gt;</span> <span class="n">onItem</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">onItemCB</span> <span class="p">=</span> <span class="n">onItem</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">IRoutePoint</span><span class="p">&gt;</span> <span class="n">onItemCB</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">Task</span> <span class="nf">CloseAsync</span><span class="p">(</span><span class="n">PartitionContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">CloseReason</span> <span class="n">reason</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Task</span> <span class="nf">OpenAsync</span><span class="p">(</span><span class="n">PartitionContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ProcessEventsAsync</span><span class="p">(</span><span class="n">PartitionContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">EventData</span><span class="p">&gt;</span> <span class="n">messages</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">message</span> <span class="k">in</span> <span class="n">messages</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">routeItem</span> <span class="p">=</span> <span class="n">AzureUtilities</span><span class="p">.</span><span class="n">DeserializeMessage</span><span class="p">&lt;</span><span class="n">RoutePointEH</span><span class="p">&gt;(</span><span class="n">message</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="n">onItemCB</span><span class="p">(</span><span class="n">routeItem</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ShouldCheckpoint</span><span class="p">())</span>
                <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">CheckpointAsync</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>and is created and registered using a simple utility method:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">EventProcessorHost</span><span class="p">&gt;</span> <span class="n">AttachProcessorForHub</span><span class="p">(</span>
    <span class="kt">string</span> <span class="n">processorName</span><span class="p">,</span> 
    <span class="kt">string</span> <span class="n">serviceBusConnectionString</span><span class="p">,</span>
    <span class="kt">string</span> <span class="n">offsetStorageConnectionString</span><span class="p">,</span>
    <span class="kt">string</span> <span class="n">eventHubName</span><span class="p">,</span>
    <span class="kt">string</span> <span class="n">consumerGroupName</span><span class="p">,</span>
    <span class="n">IEventProcessorFactory</span> <span class="n">processorFactory</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">eventProcessorHost</span> <span class="p">=</span> <span class="k">new</span> <span class="n">EventProcessorHost</span><span class="p">(</span><span class="n">processorName</span><span class="p">,</span> <span class="n">eventHubName</span><span class="p">,</span> <span class="n">consumerGroupName</span><span class="p">,</span> <span class="n">serviceBusConnectionString</span><span class="p">,</span> <span class="n">offsetStorageConnectionString</span><span class="p">);</span>
    <span class="k">await</span> <span class="n">eventProcessorHost</span><span class="p">.</span><span class="n">RegisterEventProcessorFactoryAsync</span><span class="p">(</span><span class="n">processorFactory</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">eventProcessorHost</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Note that it creates the generic EventProcessorHost class with the Event
Hub details, and then hands it a factory to create processors for each
partition. Each partition processor then is responsible for saving its
own checkpoint at an interval of its choosing (factored into the
unshown <code>ShouldCheckpoint</code> method).</p>
<p>I then create an additional wrapper class as a "point source" which
takes in a callback for what to do when new points come in and wires
everything up, allowing me to factor out all of the code for pulling
configuration values and creating the factory/processor, and even
letting me swap out Event Hubs for other "point sources" like
canned/random data or even Azure Table Storage (see <a href="https://github.com/noodlefrenzy/asp-mappy/blob/master/MappyData/RoutePointSource.cs">the
repo</a>
for details).</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">EventHubRoutePointSource</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">EventHubRoutePointSource</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">IRoutePoint</span><span class="p">&gt;</span> <span class="n">onNewPoint</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">_onPoint</span> <span class="p">=</span> <span class="n">onNewPoint</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">ehConnStr</span> <span class="p">=</span> <span class="p">...;</span>
        <span class="kt">var</span> <span class="n">storageConnStr</span> <span class="p">=</span> <span class="p">...;</span>
        <span class="kt">var</span> <span class="n">eventHubName</span> <span class="p">=</span> <span class="p">...;</span>
        <span class="kt">var</span> <span class="n">consumerGroup</span> <span class="p">=</span> <span class="p">...;</span>

        <span class="kt">var</span> <span class="n">factory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RoutePointProcessorFactory</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">_onPoint</span><span class="p">);</span>

        <span class="k">await</span> <span class="n">AzureUtilities</span><span class="p">.</span><span class="n">AttachProcessorForHub</span><span class="p">(</span><span class="s">&quot;mappy&quot;</span><span class="p">,</span> <span class="n">ehConnStr</span><span class="p">,</span> <span class="n">storageConnStr</span><span class="p">,</span> <span class="n">eventHubName</span><span class="p">,</span> <span class="n">consumerGroup</span><span class="p">,</span> <span class="n">factory</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">IRoutePoint</span><span class="p">&gt;</span> <span class="n">_onPoint</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h2>Wiring It All Together</h2>
<p>Now that I have all of the pieces, how do I wire it all together? First,
in <code>Global.asax.cs</code> we add a single line to start our chosen "point
source" and drive its incoming data into our SignalR hub:</p>
<div class="highlight"><pre><span></span><span class="n">RoutePointSourceFactory</span><span class="p">.</span><span class="n">StartAsync</span><span class="p">(</span><span class="n">AzureUtilities</span><span class="p">.</span><span class="n">FromConfiguration</span><span class="p">(</span><span class="s">&quot;RoutePointSource&quot;</span><span class="p">),</span> 
    <span class="n">pt</span> <span class="p">=&gt;</span> <span class="n">RouteHub</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">RouteHub</span><span class="p">.</span><span class="n">Hub</span><span class="p">(),</span> <span class="n">pt</span><span class="p">.</span><span class="n">UserID</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">pt</span><span class="p">.</span><span class="n">Latitude</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">pt</span><span class="p">.</span><span class="n">Longitude</span><span class="p">));</span>
</pre></div>


<p>Then in our client's "do something exciting!" section, we wire it up to
write this incoming geo data onto our map, with each user getting its
own path layer (a polyline) and "walking man" marker at the front.</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">paths</span> <span class="o">=</span> <span class="p">{};</span>
<span class="kd">var</span> <span class="nx">pathMarkers</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">iconUri</span> <span class="o">=</span> <span class="s1">&#39;/Content/Sports-Walking-icon-white.png&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">endIcon</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">icon</span><span class="p">({</span> <span class="nx">iconSize</span><span class="o">:</span> <span class="p">[</span><span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">],</span> <span class="nx">iconAnchor</span><span class="o">:</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span> <span class="nx">iconUrl</span><span class="o">:</span> <span class="nx">iconUri</span> <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">routeHub</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">routeHub</span><span class="p">;</span>
    <span class="nx">routeHub</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">newPoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">userid</span><span class="p">,</span> <span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">paths</span><span class="p">[</span><span class="nx">userid</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">paths</span><span class="p">[</span><span class="nx">userid</span><span class="p">].</span><span class="nx">addLatLng</span><span class="p">([</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pathMarkers</span><span class="p">[</span><span class="nx">userid</span><span class="p">])</span> <span class="nx">map</span><span class="p">.</span><span class="nx">removeLayer</span><span class="p">(</span><span class="nx">pathMarkers</span><span class="p">[</span><span class="nx">userid</span><span class="p">]);</span>
            <span class="nx">pathMarkers</span><span class="p">[</span><span class="nx">userid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">marker</span><span class="p">([</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="p">],</span> <span class="p">{</span> <span class="nx">icon</span><span class="o">:</span> <span class="nx">endIcon</span> <span class="p">}).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">paths</span><span class="p">[</span><span class="nx">userid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">polyline</span><span class="p">([[</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="p">]],</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="nx">weight</span><span class="o">:</span> <span class="mi">5</span> <span class="p">}).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>
            <span class="nx">pathMarkers</span><span class="p">[</span><span class="nx">userid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">marker</span><span class="p">([</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="p">],</span> <span class="p">{</span> <span class="nx">icon</span><span class="o">:</span> <span class="nx">endIcon</span> <span class="p">}).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">hub</span><span class="p">.</span><span class="nx">start</span><span class="p">().</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<h2>What Next?</h2>
<p>If you've been following along in the repo, you'll notice that the code
above is different than what is up there - that's simply due to space
constraints, this post is already in TL;DR territory and any more
features would only make that worse. The main differences between what's
here and what's in <a href="https://github.com/noodlefrenzy/asp-mappy">the repo</a>
are:</p>
<ul>
<li>I've factored out the "point source" into three distinct sources -
    an Event Hub source as outlined here, an Azure Table Storage source,
    and a "Random" source with initial points pulled from a neighborhood
    around the center and then a random walk from there.</li>
<li>I've integrated the
    fantastic <a href="https://github.com/gka/chroma.js/">Chroma.js</a> to ensure
    each path gets a unique random yet pleasing color, and made an LRU
    to limit the total number of paths I show on-screen.</li>
<li>I've integrated the remarkably easy-to-use
    <a href="https://github.com/Leaflet/Leaflet.heat">Leaflet.heat</a> to add a
    heatmap layer for each user, showing how individuals walk and where
    there "hot spots" might be.</li>
<li>I've created a simple CLI program to drive random data into the
    Event Hub, allowing easy testing.</li>
</ul>
<p>I hope I've showed you that getting a mapping web application up and
running is actually pretty easy, and integrating near-real-time data can
be done with little code using Event Hubs and SignalR. As always, my
code is <a href="https://github.com/noodlefrenzy/asp-mappy">up on GitHub</a>and is
MIT license, so do with it what you will. Let me know via comments,
twitter, or GitHub issues if you have any feedback - I'd love to hear
it.</p><p>There are <a href="http://www.mikelanzetta.com/real-time-mapping-with-signalr-and-event-hubs.html#disqus_thread">comments</a>.</p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="http://www.mikelanzetta.com/node-js-and-net-talking-eventhub-together.html" rel="bookmark"
                           title="Permalink to Node.js and .NET Talking EventHub, Together">Node.js and .NET Talking EventHub, Together</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-01-28T13:48:00-08:00">
                Published: Wed 28 January 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://www.mikelanzetta.com/author/noodlefrenzy.html">noodlefrenzy</a>
        </address>
<p>In <a href="http://www.mikelanzetta.com/category/software.html">Software</a>.</p>
<p>tags: <a href="http://www.mikelanzetta.com/tag/net.html">.NET</a> <a href="http://www.mikelanzetta.com/tag/amqp.html">AMQP</a> <a href="http://www.mikelanzetta.com/tag/azure.html">Azure</a> <a href="http://www.mikelanzetta.com/tag/c.html">C#</a> <a href="http://www.mikelanzetta.com/tag/eventhub.html">EventHub</a> <a href="http://www.mikelanzetta.com/tag/node.html">Node</a> </p>
</footer><!-- /.post-info -->                <p>Over the past few months, I've been working on <a href="https://github.com/noodlefrenzy/node-amqp10">a Node.js client for
AMQP 1.0</a> - the <em>lingua
franca</em> of Azure's EventHub and ServiceBus.  Well, the EventHub support
is just about complete, and ServiceBus Topics and Queues should follow
shortly thereafter (it's just me working on it, so it's …</p>
                <a class="readmore" href="http://www.mikelanzetta.com/node-js-and-net-talking-eventhub-together.html">read more</a>
<p>There are <a href="http://www.mikelanzetta.com/node-js-and-net-talking-eventhub-together.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="http://www.mikelanzetta.com/talking-to-eventhub-with-amqp-1-0.html" rel="bookmark"
                           title="Permalink to Talking to EventHub with AMQP 1.0">Talking to EventHub with AMQP 1.0</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-11-06T14:50:00-08:00">
                Published: Thu 06 November 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://www.mikelanzetta.com/author/noodlefrenzy.html">noodlefrenzy</a>
        </address>
<p>In <a href="http://www.mikelanzetta.com/category/software.html">Software</a>.</p>
<p>tags: <a href="http://www.mikelanzetta.com/tag/amqp.html">AMQP</a> <a href="http://www.mikelanzetta.com/tag/azure.html">Azure</a> <a href="http://www.mikelanzetta.com/tag/eventhub.html">EventHub</a> </p>
</footer><!-- /.post-info -->                <p>Lately, I've been working on a Node.js-based library for speaking AMQP
1.0, since all of the existing ones are still on 0.9.1 and don't seem
intent on updating, or are based on Qpid Proton and thus burdened with
more native code than I'd like.  It's still …</p>
                <a class="readmore" href="http://www.mikelanzetta.com/talking-to-eventhub-with-amqp-1-0.html">read more</a>
<p>There are <a href="http://www.mikelanzetta.com/talking-to-eventhub-with-amqp-1-0.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="http://www.mikelanzetta.com/talking-to-eventhub-from-node.html" rel="bookmark"
                           title="Permalink to Talking to EventHub from Node">Talking to EventHub from Node</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-09-28T13:14:00-07:00">
                Published: Sun 28 September 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://www.mikelanzetta.com/author/noodlefrenzy.html">noodlefrenzy</a>
        </address>
<p>In <a href="http://www.mikelanzetta.com/category/software.html">Software</a>.</p>
<p>tags: <a href="http://www.mikelanzetta.com/tag/azure.html">Azure</a> <a href="http://www.mikelanzetta.com/tag/eventhub.html">EventHub</a> <a href="http://www.mikelanzetta.com/tag/node.html">Node</a> </p>
</footer><!-- /.post-info -->                <p>This past week, I participated in a hackfest trying to get some
<a href="https://www.alljoyn.org/">Alljoyn</a> devices talking to
<a href="http://nitrogen.io/">Nitrogen</a>.  It was a great time, getting to learn
some new technologies, get exposed to the ~~pain ~~wonder of working
with IoT hardware, and watch my bosses (<a href="http://blogs.msdn.com/b/johnshews_blog/">John
Shewchuk</a> and <a href="http://channel9.msdn.com/Events/Visual-Studio/Visual-Studio-Live/Tracey-Trewin-Architecture-Intellitrace-DevOps-Unit-Testing">Tracey
Trewin</a>)
sling some …</p>
                <a class="readmore" href="http://www.mikelanzetta.com/talking-to-eventhub-from-node.html">read more</a>
<p>There are <a href="http://www.mikelanzetta.com/talking-to-eventhub-from-node.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://blogs.technet.microsoft.com/machinelearning/">Cortana Analytics</a></li>
                            <li><a href="http://www.kdnuggets.com/">KDNuggets</a></li>
                            <li><a href="http://www.hanselman.com/blog/">Hanselman</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://www.mikelanzetta.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/noodlefrenzy">Twitter</a></li>
                            <li><a href="https://www.linkedin.com/in/noodlefrenzy">LinkedIn</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-54597100-1', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'intelligentartifice';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>